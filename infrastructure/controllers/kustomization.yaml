# Core infrastructure controllers for the HomeProd K3s cluster
# These services are deployed before applications and configs
# Order: Helm repos → CNI → Cert-Manager → Ingress → Storage
# Note: Traefik CRDs now managed by main Traefik chart (v38+)
---
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
metadata:
  name: infra-controllers
  namespace: flux-system
resources:
  - ./helmrepositories/     # External Helm chart repositories
  - ./cert-manager/         # TLS certificate management
  - ./cilium/               # CNI and network policies
  - ./longhorn/             # Distributed block storage
  - ./sealedsecrets/        # Encrypted secrets for GitOps
  - ./traefik/              # Ingress with OAuth2, CRDs managed by chart
  - ./charts/               # Infrastructure Helm charts
  - ./shared-secrets/       # Secrets for cross-namespace sharing

patches:
  # Allow infrastructure pods to run on memory-constrained node
  - path: tolerations-patch.yaml
    target:
      kind: Deployment
  - path: tolerations-statefulset-patch.yaml
    target:
      kind: StatefulSet
  - path: tolerations-daemonset-patch.yaml
    target:
      kind: DaemonSet
