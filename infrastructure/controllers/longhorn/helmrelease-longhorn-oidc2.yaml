apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: longhorn-oauth2-proxy
  namespace: longhorn-system
spec:
  chart:
    spec:
      chart: oauth2-proxy
      version: "7.x.x"
      sourceRef:
        kind: HelmRepository
        name: oauth2-proxy
        namespace: flux-system
  interval: 5m
  values:
    nameOverride: longhorn-oauth2-proxy
    fullnameOverride: longhorn-oauth2-proxy
    extraArgs:
      - --provider=oidc
      - --oidc-issuer-url=https://idm.xrs444.net/oauth2/openid/oauth2_longhorn
      - --redirect-url=https://longhorn.xrs444.net/oauth2/callback
      - --email-domain=*
      - --upstream=http://longhorn-frontend.longhorn-system.svc.cluster.local:80/
      - --scope=openid email profile groups
      - --code-challenge-method=S256
      - --cookie-domain=.xrs444.net
      - --cookie-secure=true
      - --http-address=0.0.0.0:4180
      - --skip-oidc-discovery=true
      - --oidc-jwks-url=https://idm.xrs444.net/oauth2/openid/oauth2_longhorn/discovery/keys.jwk
      - --login-url=https://idm.xrs444.net/ui/oauth2
      - --redeem-url=https://idm.xrs444.net/oauth2/token
      - --oidc-email-claim=email
      - --oidc-groups-claim=groups
    config:
      existingSecret: oauth2-proxy-secret-longhorn
    probes:
      liveness:
        enabled: true
        initialDelaySeconds: 30
        timeoutSeconds: 5
      readiness:
        enabled: true
        initialDelaySeconds: 10
        timeoutSeconds: 5
        periodSeconds: 10
      startup:
        enabled: true
        initialDelaySeconds: 0
        timeoutSeconds: 5
        periodSeconds: 10
        failureThreshold: 60
    ingress:
      enabled: false
    service:
      type: ClusterIP
      portNumber: 4180
