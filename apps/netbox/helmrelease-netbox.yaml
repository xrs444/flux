# yamllint disable rule:line-length
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: netbox
  namespace: netbox
spec:
  interval: 30m
  timeout: 20m
  chart:
    spec:
      chart: netbox
      version: '>=7.0.0 <8.0.0'
      sourceRef:
        kind: HelmRepository
        name: netbox
        namespace: netbox
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Custom image with Diode plugin pre-installed
    image:
      registry: ghcr.io
      repository: xrs444/netbox-custom
      tag: v4.5.2

    # Basic configuration
    replicaCount: 1

    # Superuser configuration (using existing secret)
    superuser:
      enabled: true
      name: admin
      email: admin@xrs444.net
      existingSecret: netbox-superuser
      existingSecretPasswordKey: password
      existingSecretApiTokenKey: api_token

    # Use existing secret for Django secret key
    existingSecret: netbox-secret

    # Network configuration
    allowedHosts:
      - netbox.xrs444.net
      - "*"
    csrfTrustedOrigins:
      - https://netbox.xrs444.net

    # PostgreSQL configuration
    postgresql:
      enabled: true
      auth:
        username: netbox
        database: netbox
        existingSecret: netbox-secret
        secretKeys:
          adminPasswordKey: db_password
          userPasswordKey: db_password
      primary:
        persistence:
          enabled: true
          size: 10Gi

    # Valkey (Redis-compatible) configuration
    valkey:
      enabled: true
      auth:
        enabled: true
        existingSecret: netbox-secret
        existingSecretPasswordKey: redis_password

    # Persistence for media files (RWO — requires Recreate strategy)
    persistence:
      enabled: true
      size: 5Gi

    # Use Recreate strategy because the media PVC is RWO (Longhorn)
    # and cannot be mounted by multiple pods simultaneously
    updateStrategy:
      type: Recreate
    worker:
      updateStrategy:
        type: Recreate
      # Co-locate worker with main pod (shared RWO media PVC)
      affinity:
        podAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            - labelSelector:
                matchExpressions:
                  - key: app.kubernetes.io/component
                    operator: In
                    values:
                      - netbox
              topologyKey: kubernetes.io/hostname

    # Override probes — chart defaults target NGINX Unit (port 8081) which
    # no longer exists in NetBox v4.x (now uses Granian on port 8080)
    livenessProbe:
      enabled: false
    customLivenessProbe:
      httpGet:
        path: /login/
        port: http
        httpHeaders:
          - name: Host
            value: netbox.xrs444.net
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 3
      successThreshold: 1
    readinessProbe:
      enabled: true
      timeoutSeconds: 5
    startupProbe:
      enabled: true
      initialDelaySeconds: 10
      timeoutSeconds: 5

    # Disable built-in ingress (using Traefik IngressRoute)
    ingress:
      enabled: false

    # Diode plugin
    plugins:
      - netbox_diode_plugin

    # OIDC Authentication with Kanidm
    remoteAuth:
      enabled: true
      backends:
        - social_core.backends.open_id_connect.OpenIdConnectAuth
      autoCreateUser: true
      superusers:
        - xrs444

    # OIDC settings injected as Django settings via extraConfig
    # (env vars alone are not loaded into Django settings by NetBox)
    extraConfig:
      - values:
          SOCIAL_AUTH_OIDC_OIDC_ENDPOINT: "https://idm.xrs444.net/oauth2/openid/oauth2_netbox"
      - secret:
          secretName: netbox-oidc-config
          items:
            - key: oidc.yaml
              path: oidc.yaml
      - secret:
          secretName: netbox-diode-plugin-config
          items:
            - key: diode-plugin.yaml
              path: diode-plugin.yaml
      - secret:
          secretName: netbox-api-token-peppers
          items:
            - key: api-token-peppers.yaml
              path: api-token-peppers.yaml
