# yamllint disable rule:line-length
---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: netbox
  namespace: netbox
spec:
  interval: 30m
  timeout: 15m
  chart:
    spec:
      chart: netbox
      version: '>=7.0.0 <8.0.0'
      sourceRef:
        kind: HelmRepository
        name: netbox
        namespace: netbox
      interval: 12h
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Basic configuration
    replicaCount: 1

    # Superuser configuration (using existing secret)
    superuser:
      enabled: true
      name: admin
      email: admin@xrs444.net
      existingSecret: netbox-superuser
      existingSecretPasswordKey: password
      existingSecretApiTokenKey: api_token

    # Use existing secret for Django secret key
    existingSecret: netbox-secret

    # Network configuration
    allowedHosts:
      - netbox.xrs444.net
      - "*"

    # PostgreSQL configuration
    postgresql:
      enabled: true
      auth:
        username: netbox
        database: netbox
        existingSecret: netbox-secret
        secretKeys:
          adminPasswordKey: db_password
          userPasswordKey: db_password
      primary:
        persistence:
          enabled: true
          size: 10Gi

    # Valkey (Redis-compatible) configuration
    valkey:
      enabled: true
      auth:
        enabled: true
        existingSecret: netbox-secret
        existingSecretPasswordKey: redis_password

    # Persistence for media files
    persistence:
      enabled: true
      size: 5Gi

    # Disable built-in ingress (using Traefik IngressRoute)
    ingress:
      enabled: false

    # OIDC Authentication with Kanidm
    remoteAuth:
      enabled: true
      backend: social_core.backends.open_id_connect.OpenIdConnectAuth
      autoCreateUser: true

    # OIDC specific configuration
    extraEnvs:
      - name: SOCIAL_AUTH_OIDC_OIDC_ENDPOINT
        value: "https://idm.xrs444.net/oauth2/openid/oauth2_netbox"
      - name: SOCIAL_AUTH_OIDC_KEY
        valueFrom:
          secretKeyRef:
            name: oauth2-secret-netbox
            key: client-id
      - name: SOCIAL_AUTH_OIDC_SECRET
        valueFrom:
          secretKeyRef:
            name: oauth2-secret-netbox
            key: client-secret
