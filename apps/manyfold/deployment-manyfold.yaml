apiVersion: apps/v1
kind: Deployment
metadata:
  name: manyfold
  namespace: manyfold
  labels:
    app: manyfold
spec:
  revisionHistoryLimit: 3
  replicas: 1
  selector:
    matchLabels:
      app: manyfold
  template:
    metadata:
      labels:
        app: manyfold
    spec:
      containers:
        - name: manyfold
          image: ghcr.io/manyfold3d/manyfold:latest
          ports:
            - containerPort: 3214
              name: http
          env:
            - name: PUID
              value: "1000"
            - name: PGID
              value: "1000"
            - name: TZ
              value: "America/Phoenix"
            - name: DATABASE_ADAPTER
              value: "postgresql"
            - name: DATABASE_HOST
              value: "localhost"
            - name: DATABASE_PORT
              value: "5432"
            - name: DATABASE_NAME
              value: "manyfold"
            - name: DATABASE_USER
              value: "manyfold"
            - name: DATABASE_PASSWORD
              value: "manyfold"
            - name: SECRET_KEY_BASE
              value: "changeme-generate-a-secure-key"
            - name: REDIS_URL
              value: "redis://localhost:6379"
          volumeMounts:
            - name: data
              mountPath: /libraries
            - name: store
              mountPath: /store
          resources:
            requests:
              cpu: 1000m
              memory: 2Gi
            # limits:
            #   cpu: 2000m
            #   memory: 4Gi  # Temporarily removed for one-off processing
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 60
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 10
            failureThreshold: 5
        - name: postgres
          image: postgres:16-alpine
          env:
            - name: POSTGRES_DB
              value: "manyfold"
            - name: POSTGRES_USER
              value: "manyfold"
            - name: POSTGRES_PASSWORD
              value: "manyfold"
            - name: PGDATA
              value: "/var/lib/postgresql/data/pgdata"
          volumeMounts:
            - name: db
              mountPath: /var/lib/postgresql/data
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 1000m
              memory: 512Mi
        - name: redis
          image: redis:7-alpine
          ports:
            - containerPort: 6379
              name: redis
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            # limits:
            #   cpu: 500m
            #   memory: 1Gi  # Temporarily removed for one-off processing
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: manyfold-data
        - name: db
          persistentVolumeClaim:
            claimName: manyfold-db
        - name: store
          persistentVolumeClaim:
            claimName: manyfold-store
